<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary-accent: #00CFE8; /* Vibrant Cyan */
            --secondary-accent: #8A2BE2; /* Blue Violet */
            --danger: #e74c3c;
            --success: #28a745;
            --warning: #ffc107;
            --font-family: 'Tajawal', sans-serif;
            --background: #f8f9fa; 
            --text-color: #212529; 
            --card-bg: #ffffff; 
            --shadow: rgba(0, 0, 0, 0.08); 
            --border-color: #dee2e6;
        }
        body { 
            font-family: var(--font-family); 
            background-color: var(--background); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            flex-wrap: wrap; 
        }
        .header h1 { 
            color: var(--secondary-accent); 
            font-weight: 800;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.2);
        }
        #logout-btn { 
            background: var(--danger); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 700;
            transition: background-color 0.2s;
        }
        #logout-btn:hover {
            background: #c0392b;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        .tab-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 700;
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            position: relative;
            transition: color 0.3s;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-accent);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .tab-btn.active {
            color: var(--primary-accent);
        }
        .tab-btn.active::after {
            transform: scaleX(1);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .dashboard-section { 
            background: var(--card-bg); 
            border-radius: 15px; 
            box-shadow: 0 5px 20px var(--shadow); 
            padding: 25px; 
        }
        .dashboard-section h2 { 
            margin-top: 0; 
            font-size: 1.5em;
            color: #333;
        }
        .form-group { 
            margin-bottom: 15px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .form-group input { 
            flex-grow: 1; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-family: 'Tajawal', sans-serif;
            font-size: 1em;
        }
        .form-group button { 
            background-image: linear-gradient(45deg, var(--secondary-accent), var(--primary-accent));
            color: white; 
            border: none; 
            padding: 12px 22px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 700;
            transition: opacity 0.2s;
        }
        .form-group button:hover {
            opacity: 0.9;
        }

        #wallet-result, #wallet-message { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
        }
        #wallet-result { border: 1px solid var(--border-color); }
        #wallet-result.hidden { display: none; }
        #wallet-result p { margin: 8px 0; font-size: 1.1em; }
        #wallet-message.success { background: #d4edda; color: #155724; }
        #wallet-message.error { background: #f8d7da; color: #721c24; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stats { 
            font-size: 1.2em; 
            font-weight: 700; 
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
        }

        #orders-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); 
            gap: 20px; 
        }
        .order-card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            box-shadow: 0 4px 12px var(--shadow); 
            padding: 20px; 
            border-top: 5px solid var(--warning); 
        }
        .order-card.new-order { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 4px 12px var(--shadow), 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 4px 12px var(--shadow), 0 0 0 20px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 4px 12px var(--shadow), 0 0 0 0 rgba(255, 193, 7, 0); } }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; 
            margin-bottom: 15px; 
        }
        .order-id { font-size: 1.6em; font-weight: 800; color: #333; }
        .customer-name { font-weight: 700; margin-bottom: 15px; font-size: 1.1em; }
        .items-list { list-style: none; padding: 0; margin: 15px 0; }
        .items-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f8f9fa; }
        .items-list li:last-child { border-bottom: none; }
        .item-name { font-weight: 500; }
        .item-quantity { font-weight: 700; background: #e9ecef; padding: 2px 8px; border-radius: 5px; }
        .notes { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; margin-top: 15px; }
        .payment-method { 
            font-weight: 700; 
            text-align: center; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 15px; 
            font-size: 1.1em;
        }
        .payment-method.wallet { 
            background: #d4edda; 
            color: #155724; 
        }
        .payment-method.card { 
            background: #d1ecf1; 
            color: #0c5460; 
        }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-btn { 
            padding: 12px; 
            font-size: 1.1em; 
            font-weight: 700; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            color: white;
            transition: opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.9; }
        .action-btn.ready { background: var(--success); }
        .action-btn.reject { background: var(--danger); }
        #no-orders-msg { text-align: center; font-size: 1.5em; color: #6c757d; padding: 50px; grid-column: 1 / -1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>لوحة التحكم</h1>
            <button id="logout-btn" onclick="handleLogout()">تسجيل الخروج</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('orders')">الطلبات الحالية</button>
            <button class="tab-btn" onclick="showTab('wallet')">إدارة المحافظ</button>
        </div>

        <main>
            <div id="wallet-section" class="tab-content dashboard-section">
                <h2>شحن رصيد طالب</h2>
                <div class="form-group">
                    <input type="text" id="student-id-search" placeholder="أدخل الرقم الجامعي للطالب...">
                    <button onclick="findStudent()">بحث</button>
                </div>
                <div id="wallet-result" class="hidden">
                    <p><strong>اسم الطالب:</strong> <span id="student-name"></span></p>
                    <p><strong>الرصيد الحالي:</strong> <span id="current-balance"></span> جنيه</p>
                    <hr>
                    <div class="form-group">
                        <input type="number" id="charge-amount" placeholder="أدخل المبلغ المراد شحنه">
                        <button onclick="chargeWallet()">شحن الرصيد</button>
                    </div>
                </div>
                <div id="wallet-message"></div>
            </div>

            <div id="orders-section" class="tab-content dashboard-section active">
                <div class="section-header">
                     <h2>الطلبات الواردة</h2>
                     <div class="stats">إجمالي الطلبات: <span id="order-count">0</span></div>
                </div>
                <div id="orders-container">
                    <p id="no-orders-msg">لا توجد طلبات قيد التحضير حاليًا...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let password;
        let foundUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            password = localStorage.getItem('dashboardPassword');
            if (!password) {
                window.location.href = 'dashboard-login.html';
                return;
            }
            fetchOrders();
            setInterval(fetchOrders, 10000);
        });
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`${tabName}-section`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function handleLogout() {
            localStorage.removeItem('dashboardPassword');
            window.location.href = 'dashboard-login.html';
        }

        async function findStudent() {
            const studentId = document.getElementById('student-id-search').value.trim();
            const resultDiv = document.getElementById('wallet-result');
            const messageDiv = document.getElementById('wallet-message');
            
            if (!studentId) return;

            messageDiv.textContent = 'جاري البحث...';
            messageDiv.className = '';
            resultDiv.classList.add('hidden');
            foundUser = null;

            try {
                const response = await fetch('/api/find-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify({ studentId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                foundUser = data.user;
                document.getElementById('student-name').textContent = foundUser.name;
                document.getElementById('current-balance').textContent = parseFloat(foundUser.balance).toFixed(2);
                resultDiv.classList.remove('hidden');
                messageDiv.textContent = '';
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error';
            }
        }

        async function chargeWallet() {
            const amount = document.getElementById('charge-amount').value;
            const messageDiv = document.getElementById('wallet-message');

            if (!foundUser || !amount || parseFloat(amount) <= 0) {
                messageDiv.textContent = 'الرجاء البحث عن طالب أولاً وإدخال مبلغ صحيح.';
                messageDiv.className = 'error';
                return;
            }

            messageDiv.textContent = 'جاري الشحن...';
            messageDiv.className = '';

            try {
                const response = await fetch('/api/charge-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify({ userId: foundUser.id, amount })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                document.getElementById('current-balance').textContent = parseFloat(data.newBalance).toFixed(2);
                messageDiv.textContent = `تم شحن الرصيد بنجاح! الرصيد الجديد هو ${parseFloat(data.newBalance).toFixed(2)} جنيه.`;
                messageDiv.className = 'success';
                document.getElementById('charge-amount').value = '';
            } catch (error) {
                messageDiv.textContent = `فشل الشحن: ${error.message}`;
                messageDiv.className = 'error';
            }
        }

        const ordersContainer = document.getElementById('orders-container');
        const orderCountEl = document.getElementById('order-count');
        const noOrdersMsg = document.getElementById('no-orders-msg');
        let currentOrderIds = new Set();
        let audioContext;
        
        async function fetchOrders() {
            try {
                const response = await fetch('/api/all-orders', { headers: { 'Authorization': `Bearer ${password}` } });
                if (!response.ok) {
                    if (response.status === 401) handleLogout();
                    throw new Error('Failed to fetch orders.');
                }
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) {
                console.error(error);
            }
        }

        function renderOrders(orders) {
            orderCountEl.textContent = orders.length;
            noOrdersMsg.style.display = orders.length === 0 ? 'block' : 'none';

            const newOrderIds = new Set(orders.map(o => o.display_id));
            let hasNewOrder = false;
            
            for (const order of orders) {
                if (!currentOrderIds.has(order.display_id)) {
                    hasNewOrder = true;
                    break;
                }
            }
            if (hasNewOrder && document.hidden === false) {
                playNotificationSound();
            }

            document.querySelectorAll('.order-card').forEach(card => {
                if (!newOrderIds.has(card.dataset.orderId)) {
                    card.remove();
                }
            });
            
            orders.forEach(order => {
                if (document.querySelector(`.order-card[data-order-id='${order.display_id}']`)) return;

                const card = document.createElement('div');
                card.className = 'order-card new-order';
                card.dataset.orderId = order.display_id;

                const itemsHtml = order.items.map(item => `<li><span class="item-name">${item.name}</span><span class="item-quantity">x${item.quantity}</span></li>`).join('');
                const notesHtml = order.notes ? `<div class="notes"><strong>ملاحظات:</strong> ${order.notes}</div>` : '';
                const paymentHtml = `<div class="payment-method ${order.paymentMethod.toLowerCase().includes('card') ? 'card' : 'wallet'}">${order.paymentMethod === 'Wallet' ? 'محفظة' : 'بطاقة بنكية'}</div>`;

                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${order.display_id}</span>
                        <span class="order-time">${new Date(order.created_at).toLocaleTimeString('ar-EG')}</span>
                    </div>
                    <p class="customer-name">العميل: <strong>${order.users.name} (${order.users.studentId})</strong></p>
                    <ul class="items-list">${itemsHtml}</ul>
                    ${notesHtml}
                    ${paymentHtml}
                    <div class="action-buttons">
                        <button class="action-btn reject" onclick="rejectOrder('${order.display_id}')">رفض</button>
                        <button class="action-btn ready" onclick="updateOrderStatus('${order.display_id}')">جاهز للاستلام</button>
                    </div>
                `;
                ordersContainer.prepend(card);
                setTimeout(() => card.classList.remove('new-order'), 3000);
            });
            currentOrderIds = newOrderIds;
        }
        
        async function updateOrderStatus(orderId) {
            try {
                const response = await fetch('/api/update-order-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify({ orderId, status: 'جاهز للاستلام' })
                });
                if (!response.ok) throw new Error('Failed to update status.');
                removeCardFromUI(orderId);
            } catch (error) {
                console.error(error);
                alert('فشل تحديث حالة الطلب. الرجاء المحاولة مرة أخرى.');
            }
        }
        
        async function rejectOrder(orderId) {
            const reason = prompt("ما هو سبب رفض الطلب؟ (مثال: الصنف غير متوفر)");
            if (!reason || reason.trim() === '') return;

            try {
                const response = await fetch('/api/reject-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify({ orderId, reason })
                });
                if (!response.ok) throw new Error('Failed to reject order.');
                removeCardFromUI(orderId);
            } catch (error) {
                console.error(error);
                alert('فشل رفض الطلب. الرجاء المحاولة مرة أخرى.');
            }
        }

        function removeCardFromUI(orderId) {
            const cardToRemove = document.querySelector(`.order-card[data-order-id='${orderId}']`);
            if (cardToRemove) cardToRemove.remove();
            currentOrderIds.delete(orderId);
            const remainingCards = document.querySelectorAll('.order-card').length;
            orderCountEl.textContent = remainingCards;
            noOrdersMsg.style.display = remainingCards === 0 ? 'block' : 'none';
        }
        
        function playNotificationSound() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }
    </script>
</body>
</html>

