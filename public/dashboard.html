<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Bella Vita</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-yellow: #FDCB01;
            --primary-red: #D72323;
            --dark-bg: #121212;
            --card-bg: #1E1E1E;
            --text-light: #EAEAEA;
            --border-color: rgba(253, 203, 1, 0.2);
            --font-family: 'Tajawal', sans-serif;
            --header-font: 'Poppins', sans-serif;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --success: #28a745;
            --danger: #e74c3c;
            --blue: #3498db;
            --pulse-color: #00CFE8; /* Cyan pulse color */
        }

        body { 
            font-family: var(--font-family); 
            background-color: var(--dark-bg); 
            color: var(--text-light); 
            margin: 0; 
            padding: 20px; 
        }
        .container { max-width: 1400px; margin: auto; }
        h1, h2, h3 { font-family: var(--header-font); font-weight: 700; }
        .hidden { display: none !important; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 { color: var(--primary-yellow); font-weight: 900; text-transform: uppercase; }
        #logout-btn { background: var(--primary-red); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 700; }

        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab-btn { padding: 12px 25px; font-size: 1.1em; font-weight: 700; background: none; border: none; cursor: pointer; color: #888; position: relative; }
        .tab-btn::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background: var(--primary-yellow); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-btn.active { color: var(--primary-yellow); }
        .tab-btn.active::after { transform: scaleX(1); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-section { background: var(--card-bg); border-radius: 4px; box-shadow: 0 5px 20px var(--shadow-color); padding: 25px; border: 1px solid var(--border-color); }
        .dashboard-section h2 { margin-top: 0; font-size: 1.5em; }
        
        .form-group { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .form-group input { flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Tajawal'; background: var(--dark-bg); color: var(--text-light); }
        .form-group button { background: var(--blue); color: white; border: none; padding: 12px 22px; border-radius: 4px; cursor: pointer; font-weight: 700; }
        #wallet-result, #wallet-message { margin-top: 20px; padding: 15px; border-radius: 4px; }
        #wallet-message.success { background: rgba(40, 167, 69, 0.2); color: var(--success); }
        #wallet-message.error { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        #orders-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .order-card { 
            background: var(--card-bg); 
            border-radius: 4px; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            padding: 20px; 
            border-top: 5px solid var(--primary-yellow); 
            transition: all 0.3s ease;
        }
        /* --- NEW ORDER HIGHLIGHT --- */
        .order-card.new-order {
            border-top-color: var(--pulse-color);
            animation: pulse 1.5s 2;
        }
        @keyframes pulse { 
            0% { box-shadow: 0 4px 12px var(--shadow-color), 0 0 0 0 rgba(0, 207, 232, 0.7); } 
            70% { box-shadow: 0 4px 12px var(--shadow-color), 0 0 0 20px rgba(0, 207, 232, 0); } 
            100% { box-shadow: 0 4px 12px var(--shadow-color), 0 0 0 0 rgba(0, 207, 232, 0); } 
        }
        /* --- END HIGHLIGHT --- */

        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .order-id { font-size: 1.6em; font-weight: 800; }
        .items-list { list-style: none; padding: 0; margin: 15px 0; }
        .items-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .item-quantity { font-weight: 700; background: var(--dark-bg); padding: 2px 8px; border-radius: 5px; }
        .notes { background: #332E1A; color: #FDCB01; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; margin-top: 15px; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-btn { padding: 12px; font-size: 1.1em; font-weight: 700; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .action-btn.ready { background: var(--success); }
        .action-btn.reject { background: var(--danger); }
        #no-orders-msg { text-align: center; font-size: 1.5em; color: #888; padding: 50px; grid-column: 1 / -1; }

        /* Analytics Section */
        .analytics-filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 15px; border-radius: 50px; cursor: pointer; font-weight: 700; }
        .filter-btn.active { background: var(--primary-yellow); color: var(--text-dark); border-color: var(--primary-yellow); }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stat-card { background: var(--card-bg); border-radius: 4px; padding: 20px; border: 1px solid var(--border-color); }
        .stat-card h3 { margin-top: 0; color: var(--primary-yellow); }
        .stat-card .value { font-size: 2.5em; font-weight: 800; }
        .stat-list { list-style-type: none; padding: 0; }
        .stat-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        #analytics-loader { text-align: center; padding: 40px; font-size: 1.2em; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1001; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 4px; width: 90%; max-width: 400px; border: 1px solid var(--border-color); }
        .modal-content h3 { margin-top: 0; }
        .modal-content input[type="text"] { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--dark-bg); color: var(--text-light); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex-grow: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>لوحة التحكم</h1>
            <button id="logout-btn" onclick="handleLogout()">تسجيل الخروج</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('orders')">الطلبات الحالية</button>
            <button class="tab-btn" onclick="showTab('wallet')">إدارة المحافظ</button>
            <button class="tab-btn" onclick="showTab('analytics')">التحليلات</button>
        </div>

        <main>
            <div id="wallet-section" class="tab-content dashboard-section">
                 <h2>شحن رصيد طالب</h2>
                <div class="form-group">
                    <input type="text" id="student-id-search" placeholder="أدخل الرقم الجامعي للطالب...">
                    <button onclick="findStudent()">بحث</button>
                </div>
                <div id="wallet-result" class="hidden">
                    <p><strong>اسم الطالب:</strong> <span id="student-name"></span></p>
                    <p><strong>الرصيد الحالي:</strong> <span id="current-balance"></span> جنيه</p>
                    <hr>
                    <div class="form-group">
                        <input type="number" id="charge-amount" placeholder="أدخل المبلغ المراد شحنه">
                        <button onclick="chargeWallet()">شحن الرصيد</button>
                    </div>
                </div>
                <div id="wallet-message"></div>
            </div>

            <div id="orders-section" class="tab-content dashboard-section active">
                 <div class="section-header" style="justify-content: flex-end;">
                     <div class="stats">إجمالي الطلبات: <span id="order-count">0</span></div>
                </div>
                 <div id="orders-container">
                    <p id="no-orders-msg">لا توجد طلبات قيد التحضير حاليًا...</p>
                </div>
            </div>
            
            <div id="analytics-section" class="tab-content dashboard-section">
                <h2>نظرة عامة على الأداء</h2>
                <div class="analytics-filters">
                    <button class="filter-btn active" data-period="day" onclick="loadAnalytics('day', this)">آخر 24 ساعة</button>
                    <button class="filter-btn" data-period="week" onclick="loadAnalytics('week', this)">آخر 7 أيام</button>
                    <button class="filter-btn" data-period="month" onclick="loadAnalytics('month', this)">آخر 30 يوم</button>
                </div>
                <div id="analytics-loader">جاري تحميل البيانات...</div>
                <div id="analytics-content" class="hidden">
                    <div class="analytics-grid">
                        <div class="stat-card"><h3>إجمالي الإيرادات</h3><p class="value"><span id="total-revenue">0</span> جنيه</p></div>
                        <div class="stat-card"><h3>إجمالي الطلبات</h3><p class="value" id="total-orders">0</p></div>
                        <div class="stat-card"><h3>الأصناف الأكثر مبيعًا</h3><ul id="top-items-list" class="stat-list"></ul></div>
                        <div class="stat-card"><h3>أفضل العملاء</h3><ul id="top-customers-list" class="stat-list"></ul></div>
                         <div class="stat-card" style="grid-column: 1 / -1;"><h3>أوقات الذروة</h3><ul id="peak-hours-list" class="stat-list"></ul></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reject Reason Modal -->
    <div id="reject-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>سبب رفض الطلب</h3>
            <input type="text" id="reject-reason-input" class="form-group" placeholder="مثال: الصنف غير متوفر">
            <div class="modal-actions">
                <button class="action-btn" style="background: #888;" onclick="closeRejectModal()">إلغاء</button>
                <button class="action-btn reject" id="confirm-reject-btn">تأكيد الرفض</button>
            </div>
        </div>
    </div>


    <script>
        let password;
        let foundUser = null;
        let currentOrderIds = new Set();
        let audioContext;

        document.addEventListener('DOMContentLoaded', () => {
            password = localStorage.getItem('dashboardPassword');
            if (!password) { window.location.href = 'dashboard-login.html'; return; }
            
            fetchOrders();
            setInterval(fetchOrders, 10000); // Check for orders every 10 seconds
            loadAnalytics('day', document.querySelector('.filter-btn[data-period="day"]'));
        });
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`${tabName}-section`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function handleLogout() {
            localStorage.removeItem('dashboardPassword');
            window.location.href = 'dashboard-login.html';
        }

        // --- Analytics Logic ---
        async function loadAnalytics(period, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');

            const loader = document.getElementById('analytics-loader');
            const content = document.getElementById('analytics-content');
            loader.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                const response = await fetch(`/api/analytics?period=${period}`, { headers: { 'Authorization': `Bearer ${password}` } });
                if (!response.ok) throw new Error('Failed to fetch analytics.');
                const data = await response.json();
                renderAnalytics(data);
            } catch (error) {
                loader.textContent = 'فشل تحميل البيانات.';
                console.error(error);
            }
        }

        function renderAnalytics(data) {
            document.getElementById('total-revenue').textContent = data.totalRevenue;
            document.getElementById('total-orders').textContent = data.totalOrders;
            document.getElementById('top-items-list').innerHTML = data.topItems.map(item => `<li><span>${item.name}</span><span class="count">${item.count} مرة</span></li>`).join('');
            document.getElementById('top-customers-list').innerHTML = data.topCustomers.map(c => `<li><span>${c.name}</span><span class="count">${c.total} جنيه</span></li>`).join('');
            document.getElementById('peak-hours-list').innerHTML = data.peakHours.slice(0, 3).map(h => `<li><span>الساعة ${h.hour % 12 || 12} ${h.hour >= 12 ? 'م' : 'ص'}</span><span class="count">${h.count} طلب</span></li>`).join('');
            
            document.getElementById('analytics-loader').classList.add('hidden');
            document.getElementById('analytics-content').classList.remove('hidden');
        }

        // --- Wallet Logic ---
        async function findStudent() {
            const studentId = document.getElementById('student-id-search').value.trim();
            const resultDiv = document.getElementById('wallet-result');
            const messageDiv = document.getElementById('wallet-message');
            if (!studentId) return;
            messageDiv.textContent = 'جاري البحث...';
            messageDiv.className = '';
            resultDiv.classList.add('hidden');
            foundUser = null;
            try {
                const response = await fetch('/api/find-user', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` }, body: JSON.stringify({ studentId }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                foundUser = data.user;
                document.getElementById('student-name').textContent = foundUser.name;
                document.getElementById('current-balance').textContent = parseFloat(foundUser.balance).toFixed(2);
                resultDiv.classList.remove('hidden');
                messageDiv.textContent = '';
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error';
            }
        }
        async function chargeWallet() {
            const amount = document.getElementById('charge-amount').value;
            const messageDiv = document.getElementById('wallet-message');
            if (!foundUser || !amount || parseFloat(amount) <= 0) {
                messageDiv.textContent = 'الرجاء البحث عن طالب أولاً وإدخال مبلغ صحيح.';
                messageDiv.className = 'error';
                return;
            }
            messageDiv.textContent = 'جاري الشحن...';
            try {
                const response = await fetch('/api/charge-wallet', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` }, body: JSON.stringify({ userId: foundUser.id, amount }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                document.getElementById('current-balance').textContent = parseFloat(data.newBalance).toFixed(2);
                messageDiv.textContent = `تم شحن الرصيد بنجاح! الرصيد الجديد هو ${parseFloat(data.newBalance).toFixed(2)} جنيه.`;
                messageDiv.className = 'success';
                document.getElementById('charge-amount').value = '';
            } catch (error) {
                messageDiv.textContent = `فشل الشحن: ${error.message}`;
                messageDiv.className = 'error';
            }
        }
        
        // --- Orders Logic (SMART UPDATE) ---
        async function fetchOrders() {
            try {
                const response = await fetch('/api/all-orders', { headers: { 'Authorization': `Bearer ${password}` } });
                if (!response.ok) { if (response.status === 401) handleLogout(); throw new Error('Failed to fetch orders.'); }
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) { console.error(error); }
        }

        function renderOrders(orders) {
            const ordersContainer = document.getElementById('orders-container');
            const noOrdersMsg = document.getElementById('no-orders-msg');
            const orderCountEl = document.getElementById('order-count');

            orderCountEl.textContent = orders.length;
            if (orders.length === 0) {
                ordersContainer.innerHTML = ''; // Clear container
                noOrdersMsg.style.display = 'block';
                ordersContainer.appendChild(noOrdersMsg);
            } else {
                noOrdersMsg.style.display = 'none';
            }
            
            const newOrderIds = new Set(orders.map(o => o.display_id));
            let hasNewOrder = false;

            // 1. Remove orders that are no longer in the list (completed/rejected)
            document.querySelectorAll('.order-card').forEach(card => {
                if (!newOrderIds.has(card.dataset.orderId)) {
                    card.remove();
                }
            });

            // 2. Add new orders
            orders.forEach(order => {
                // Check if this order is already on screen
                if (document.querySelector(`.order-card[data-order-id='${order.display_id}']`)) {
                    return; // Already exists, do nothing
                }

                // --- This is a NEW order ---
                hasNewOrder = true;
                const card = document.createElement('div');
                card.className = 'order-card new-order'; // Add highlight
                card.dataset.orderId = order.display_id;
                const itemsHtml = order.items.map(item => `<li><span>${item.name}</span><span class="item-quantity">x${item.quantity}</span></li>`).join('');
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="order-id">${order.display_id}</span>
                        <span>${new Date(order.created_at).toLocaleTimeString('ar-EG')}</span>
                    </div>
                    <p>العميل: <strong>${order.users.name} (${order.users.studentId})</strong></p>
                    <ul class="items-list">${itemsHtml}</ul>
                    ${order.notes ? `<div class="notes"><strong>ملاحظات:</strong> ${order.notes}</div>` : ''}
                    <div class="action-buttons">
                        <button class="action-btn reject" onclick="openRejectModal('${order.display_id}')">رفض</button>
                        <button class="action-btn ready" onclick="handleOrderAction('/api/update-order-status', { orderId: '${order.display_id}', status: 'جاهز للاستلام' }, 'فشل تحديث حالة الطلب.')">جاهز للاستلام</button>
                    </div>`;
                
                ordersContainer.prepend(card); // Add new orders to the top
                setTimeout(() => {
                    card.classList.remove('new-order');
                }, 4000); // Remove pulse after 4 seconds
            });

            if (hasNewOrder && document.hidden === false) {
                playNotificationSound();
            }
            
            // Update the set of current IDs for the next check
            currentOrderIds = newOrderIds;
        }

        async function handleOrderAction(endpoint, body, errorMessage) {
            try {
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` }, body: JSON.stringify(body) });
                if (!response.ok) throw new Error(errorMessage);
                removeCardFromUI(body.orderId);
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }
        
        function removeCardFromUI(orderId) {
            const card = document.querySelector(`.order-card[data-order-id='${orderId}']`);
            if (card) card.remove();
            
            currentOrderIds.delete(orderId); // Remove from our set
            const remainingCards = document.querySelectorAll('.order-card').length;
            document.getElementById('order-count').textContent = remainingCards;
            if (remainingCards === 0) {
                 document.getElementById('no-orders-msg').style.display = 'block';
            }
        }
        
        function playNotificationSound() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // --- Reject Modal Logic ---
        function openRejectModal(orderId) {
            const modal = document.getElementById('reject-modal');
            modal.classList.add('show');
            document.getElementById('confirm-reject-btn').onclick = () => confirmReject(orderId);
        }
        function closeRejectModal() {
            document.getElementById('reject-modal').classList.remove('show');
            document.getElementById('reject-reason-input').value = '';
        }
        function confirmReject(orderId) {
            const reason = document.getElementById('reject-reason-input').value.trim();
            if (!reason) {
                alert("الرجاء إدخال سبب الرفض.");
                return;
            }
            handleOrderAction('/api/reject-order', { orderId, reason }, 'فشل رفض الطلب.');
            closeRejectModal();
        }
    </script>
</body>
</html>

