<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <title>نظام طلبات الكافيتريا</title>
  <style>
    /* --- NEW CREATIVE THEME: "NEON FRESH" --- */
    :root {
      --primary-accent: #00CFE8; /* Vibrant Cyan */
      --secondary-accent: #8A2BE2; /* Blue Violet */
      --danger: #e74c3c;
      --success: #28a745;
      --warning: #ffc107;
      --font-family: 'Tajawal', sans-serif;

      /* Dark Mode (Default) */
      --background: #101729; /* Deep Navy Blue */
      --text-color: #f1faee;
      --card-bg: rgba(22, 32, 57, 0.7);
      --input-bg: rgba(22, 32, 57, 0.9);
      --border-color: rgba(0, 207, 232, 0.2);
      --shadow-color: rgba(0, 207, 232, 0.1);
    }

    body.light-mode {
      --background: #f8f9fa;
      --text-color: #212529;
      --card-bg: rgba(255, 255, 255, 0.7);
      --input-bg: #ffffff;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }

    body { 
      font-family: var(--font-family); 
      background-color: var(--background); 
      color: var(--text-color); 
      margin: 0; 
      padding: 15px; 
      overflow-x: hidden; 
      direction: rtl; 
      transition: background-color 0.4s, color 0.4s; 
    }
    .hidden { display: none !important; }

    /* --- General & Auth Styles --- */
    .logo { 
      font-size: 3em; 
      font-weight: 800; 
      color: var(--primary-accent); 
      text-align: center;
      text-shadow: 0 0 10px var(--primary-accent), 0 0 20px rgba(0, 207, 232, 0.5);
    }
    .auth-container { 
      max-width: 400px; 
      margin: 20px auto; 
      padding: 30px; 
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px; 
      text-align: center; 
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 32px 0 var(--shadow-color);
    }
    .auth-input { 
      width: calc(100% - 24px); 
      padding: 12px; 
      margin-bottom: 15px; 
      border-radius: 10px; 
      border: 1px solid var(--border-color); 
      background: var(--input-bg); 
      color: var(--text-color); 
      font-family: var(--font-family); 
      font-size: 1em;
    }
    .auth-input:focus {
        outline: none;
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 3px rgba(0, 207, 232, 0.3);
    }
    .auth-btn { 
      width: 100%; 
      padding: 12px; 
      font-size: 1.1em; 
      background-image: linear-gradient(45deg, var(--secondary-accent), var(--primary-accent)); 
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 700; 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(138, 43, 226, 0.4);
    }
    .auth-toggle { color: var(--warning); cursor: pointer; margin-top: 20px; display: inline-block; font-weight: 500; }
    .auth-error { color: var(--danger); min-height: 20px; font-weight: 700; }

    /* --- App Header & Action Bar --- */
    .header { text-align: center; margin-bottom: 20px; }
    .welcome-msg { font-size: 1.3em; font-weight: 700; margin-top: 10px; }
    .welcome-msg .name { color: var(--primary-accent); }
    .action-bar { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .action-btn { 
      position: relative; 
      padding: 10px 20px; 
      font-size: 1em; 
      border: none; 
      border-radius: 25px; 
      cursor: pointer; 
      font-family: var(--font-family); 
      font-weight: 700; 
      transition: all 0.2s ease; 
      color: #fff;
    }
    .action-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .action-btn.wallet { background: var(--success); }
    .action-btn.cart { background-image: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent)); }
    .action-btn.tracking { background-image: linear-gradient(45deg, #4facfe, #00f2fe); }
    .action-btn.history { background-image: linear-gradient(45deg, #a280ff, #f280ff); }
    #theme-toggle-btn { background: #495057; color: var(--warning); font-size: 1.2em; line-height: 1; }
    body.light-mode #theme-toggle-btn { background: #e9ecef; color: var(--secondary-accent); }
    .action-count { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 600; border: 2px solid var(--background); }
    
    /* --- Menu & Categories --- */
    .search-container { max-width: 800px; margin: 30px auto; }
    #search-input { 
      width: calc(100% - 24px); 
      padding: 12px; 
      border-radius: 25px; 
      border: 1px solid var(--border-color); 
      background: var(--card-bg); 
      color: var(--text-color); 
      font-family: var(--font-family); 
      font-size: 1.1em; text-align: center;
      transition: all 0.3s;
    }
     #search-input:focus {
        outline: none;
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 4px rgba(0, 207, 232, 0.3);
    }
    #categories-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: auto; }
    .category-card { 
      background-color: var(--card-bg); 
      backdrop-filter: blur(5px);
      height: 150px; 
      border-radius: 15px; 
      cursor: pointer; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      gap: 10px; 
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    .category-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 0, rgba(0, 207, 232, 0.2), transparent 70%);
        opacity: 0;
        transition: opacity 0.4s;
    }
    .category-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 10px 25px var(--shadow-color); 
    }
    .category-card:hover::before {
        opacity: 1;
    }
    .category-card-icon { font-size: 3.5em; line-height: 1; z-index: 1; }
    .category-card-title { color: var(--text-color); font-size: 1.6em; font-weight: 700; text-align: center; z-index: 1; }
    
    .menu-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-accent); padding-bottom: 10px; margin: 30px 0 25px 0;}
    .category-title { font-size: 2em; font-weight: 700; color: var(--primary-accent); }
    .back-btn { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; }
    
    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .item-card { 
      background: var(--card-bg); 
      border-radius: 15px; 
      display: flex; 
      align-items: center; 
      padding: 15px;
      border: 1px solid var(--border-color);
    }
    .item-details { flex-grow: 1; display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 5px 15px; align-items: center; }
    .item-name { font-size: 1.2em; font-weight: 700; margin: 0; }
    .item-price { font-size: 1.3em; font-weight: 800; color: var(--warning); margin: 0; }
    .item-actions { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .add-to-cart-btn { 
        background-image: linear-gradient(45deg, var(--secondary-accent), var(--primary-accent));
        color: white; 
        border-radius: 20px; 
        padding: 8px 15px; 
        font-weight: 700; 
        cursor: pointer;
        border: none;
    }

    /* --- Modals --- */
    .modal-overlay { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background: rgba(0,0,0,0.6); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 1001; 
      opacity: 0; 
      transition: opacity 0.3s ease; 
    }
    .modal-overlay.show { display: flex; opacity: 1; }
    .modal-content { 
      background: var(--card-bg); 
      backdrop-filter: blur(15px); 
      -webkit-backdrop-filter: blur(15px);
      width: 90%; 
      max-width: 600px; 
      border-radius: 20px; 
      padding: 25px; 
      max-height: 85vh; 
      overflow-y: auto; 
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }
    .close-modal { float: left; cursor: pointer; font-size: 1.5em; color: #aaa; }
    #cart-items-list li, #history-items-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .remove-item-btn { background: none; border: none; color: var(--danger); font-size: 1.4em; cursor: pointer; }
    .status-ready { color: var(--success); }
    .status-pending { color: var(--warning); }
    .status-rejected { color: var(--danger); }
    .reorder-btn { background: none; border: 1px solid var(--warning); color: var(--warning); border-radius: 15px; padding: 5px 10px; font-size: 0.8em; cursor: pointer; margin-top: 5px; }
    #total-price { font-size: 1.5em; font-weight: bold; color: var(--primary-accent); text-align: left; margin-top: 20px; }
    .modal-input { width: calc(100% - 22px); padding: 12px; margin-top: 15px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-family: var(--font-family); }
    .modal-btn { 
      width: 100%; 
      padding: 15px; 
      font-size: 1.2em; 
      margin-top: 20px; 
      background-image: linear-gradient(45deg, var(--secondary-accent), var(--primary-accent)); 
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
    }
    .modal-btn#paymob-order-btn { background-image: linear-gradient(45deg, #0288d1, #26c6da); margin-top: 10px;}
    .modal-btn:disabled { background-image: linear-gradient(45deg, #555, #333); cursor: not-allowed; }
    #tracking-result { margin-top: 15px; font-size: 1.2em; font-weight: 700; min-height: 20px; text-align: center; }
    
    /* --- Overlays & Loaders --- */
    .loader { text-align: center; padding: 50px; font-size: 1.5em; color: var(--primary-accent); font-weight: 700; }
    .footer-wrapper { text-align: center; margin-top: 40px; color: #888; font-size: 0.9em; }
    #payment-confirm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 23, 41, 0.9); backdrop-filter: blur(5px); z-index: 2000; display: none; justify-content: center; align-items: center; text-align: center; flex-direction: column; color: white; }
    .spinner { border: 8px solid rgba(255,255,255,0.2); border-top: 8px solid var(--primary-accent); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 25px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* --- Responsive --- */
    @media (max-width: 768px) { 
        .action-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: var(--card-bg); 
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color); 
            z-index: 1000; 
            margin: 0; 
            padding: 10px; 
            justify-content: space-around; 
            border-radius: 20px 20px 0 0; 
        } 
        body { padding-bottom: 90px; } 
        #categories-container { grid-template-columns: 1fr 1fr; gap: 15px; } 
        .category-card { height: 120px; } 
    }
  </style>
</head>
<body>
  <div id="payment-confirm-overlay"><div class="spinner"></div><h2>جاري تأكيد الدفع...</h2></div>
  <div id="auth-view">
    <h1 class="logo">نظام الطلبات</h1>
    <div id="login-container" class="auth-container">
      <h2>تسجيل الدخول</h2><p id="login-error" class="auth-error"></p><input type="text" id="login-id" class="auth-input" placeholder="الرقم الجامعي"><input type="password" id="login-password" class="auth-input" placeholder="كلمة المرور"><button class="auth-btn" onclick="handleLogin()">دخول</button><p class="auth-toggle" onclick="toggleAuthView()">ليس لديك حساب؟ أنشئ واحدًا</p>
    </div>
    <div id="signup-container" class="auth-container hidden">
      <h2>إنشاء حساب جديد</h2><p id="signup-error" class="auth-error"></p><input type="text" id="signup-name" class="auth-input" placeholder="الاسم بالكامل"><input type="text" id="signup-id" class="auth-input" placeholder="الرقم الجامعي"><input type="password" id="signup-password" class="auth-input" placeholder="كلمة المرور"><button class="auth-btn" onclick="handleSignUp()">إنشاء حساب</button><p class="auth-toggle" onclick="toggleAuthView()">لديك حساب بالفعل؟ سجل الدخول</p>
    </div>
  </div>

  <div id="app-view" class="hidden">
    <header class="header">
      <h1 class="logo">نظام الطلبات</h1><h2 id="welcome-msg" class="welcome-msg"></h2>
    </header>
    <div class="action-bar">
      <button id="wallet-btn" class="action-btn wallet" onclick="alert('يمكنك شحن رصيدك من الكاشير مباشرة.')">رصيدك: 0.00 جنيه</button>
      <button class="action-btn cart" onclick="toggleModal('cart-modal-overlay')">السلة<span id="cart-item-count" class="action-count" style="display: none;">0</span></button>
      <button id="tracking-btn" class="action-btn tracking" onclick="toggleModal('tracking-modal-overlay')">تتبع طلبك</button>
      <button id="history-btn" class="action-btn history" onclick="toggleModal('history-modal-overlay')">سجل الطلبات</button>
      <button id="theme-toggle-btn" class="action-btn" onclick="toggleTheme()">🌙</button>
    </div>
    <div class="search-container"><input type="search" id="search-input" placeholder="ابحث عن أكلة معينة..." oninput="filterMenu()"></div>
    <div id="loader" class="loader">جاري تحضير المنيو...</div>
    <main id="main-content">
      <div id="categories-container"></div>
      <div id="menu-container" class="hidden"></div>
    </main>
  </div>

  <!-- Modals -->
  <div id="cart-modal-overlay" class="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="toggleModal('cart-modal-overlay')">&times;</span><h2>سلة الطلبات</h2><textarea id="order-notes" class="modal-input" placeholder="أي ملاحظات للشيف؟ (اختياري)"></textarea><ul id="cart-items-list" style="list-style: none; padding: 0;"></ul><div id="total-price">الإجمالي: 0.00 جنيه</div><button id="order-btn" class="modal-btn" onclick="placeWalletOrder()">اطلب الآن من المحفظة</button><button id="paymob-order-btn" class="modal-btn" onclick="initiateCardPayment()">ادفع بالبطاقة البنكية</button></div></div>
  <div id="tracking-modal-overlay" class="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="toggleModal('tracking-modal-overlay')">&times;</span><h3>تتبع طلبك</h3><input type="text" id="order-id-input" class="modal-input" style="text-align: center;" placeholder="أدخل رقم الطلب هنا (مثال: chilli-0001)"><button class="modal-btn" style="background-image: linear-gradient(45deg, #4facfe, #00f2fe);" onclick="trackMyOrder()">تتبع</button><p id="tracking-result"></p></div></div>
  <div id="history-modal-overlay" class="modal-overlay"><div class="modal-content"><span class="close-modal" onclick="toggleModal('history-modal-overlay')">&times;</span><h2>سجل الطلبات</h2><ul id="history-items-list" style="list-style: none; padding: 0;"></ul></div></div>
  
  <div class="footer-wrapper"><p>Developed By 7MAD</p></div>

<script>
  // All JS logic remains the same
  let currentUser = null, cart = {}, allMenuItems = {};
  const authView = document.getElementById('auth-view');
  const appView = document.getElementById('app-view');
  const loader = document.getElementById('loader');

  async function apiCall(endpoint, options = {}) {
    const token = localStorage.getItem('sessionToken');
    if (token) {
      options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
    }
    const response = await fetch(`/api/${endpoint}`, options);
    if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Something went wrong');
    }
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.indexOf("application/json") !== -1) {
        return response.json();
    } else {
        return response.text();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sessionToken = localStorage.getItem('sessionToken');
    if (sessionToken) showAppView(); else showAuthView();
    
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true' && urlParams.get('id')) {
        document.getElementById('payment-confirm-overlay').style.display = 'flex';
        setTimeout(() => {
            alert(`تم تأكيد الدفع واستلام طلبك بنجاح!`);
            window.location.href = window.location.pathname; 
        }, 3000);
    }
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
        document.getElementById('theme-toggle-btn').innerHTML = '☀️';
    }
  });

  async function handleLogin() {
    const studentId = document.getElementById('login-id').value, password = document.getElementById('login-password').value, errorEl = document.getElementById('login-error');
    errorEl.textContent = 'جاري تسجيل الدخول...';
    try {
      const { session } = await apiCall('login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studentId, password }) });
      localStorage.setItem('sessionToken', session.access_token);
      showAppView();
    } catch (error) { errorEl.textContent = error.message; }
  }

  async function handleSignUp() {
    const name = document.getElementById('signup-name').value, studentId = document.getElementById('signup-id').value, password = document.getElementById('signup-password').value, errorEl = document.getElementById('signup-error');
    errorEl.textContent = 'جاري إنشاء الحساب...';
    try {
      const { session } = await apiCall('signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, studentId, password }) });
      localStorage.setItem('sessionToken', session.access_token);
      showAppView();
    } catch (error) { errorEl.textContent = error.message; }
  }

  function handleLogout() { localStorage.removeItem('sessionToken'); showAuthView(); }
  function showAuthView() { authView.classList.remove('hidden'); appView.classList.add('hidden'); }
  function showAppView() { authView.classList.add('hidden'); appView.classList.remove('hidden'); initializeApp(); }
  function toggleAuthView() { document.getElementById('login-container').classList.toggle('hidden'); document.getElementById('signup-container').classList.toggle('hidden'); }

  async function initializeApp() {
    loader.classList.remove('hidden');
    document.getElementById('categories-container').classList.add('hidden');
    document.getElementById('menu-container').classList.add('hidden');
    try {
      const [userDetails, menuData] = await Promise.all([apiCall('user-details'), apiCall('menu')]);
      currentUser = userDetails;
      document.getElementById('welcome-msg').innerHTML = `مرحبًا <span class="name">${currentUser.name}</span>، جاهز تطلب النهاردة؟`;
      document.getElementById('wallet-btn').textContent = `رصيدك: ${parseFloat(currentUser.balance).toFixed(2)} جنيه`;
      allMenuItems = menuData;
      displayCategories();
    } catch (error) {
      alert(`حدث خطأ: ${error.message}`);
      if (error.message.includes('Invalid token')) handleLogout();
    } finally {
      loader.classList.add('hidden');
    }
  }

  function displayCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';
    const categoryOrder = ["الكريبات 🥙", "الأطباق 🥣", "الوجبات العربي 🫔", "ساندويتش سوري 🌯", "ساندويتش فرنساوي 🥖", "الريزو 🍚", "ملوك الدايت 💪", "الاضافات 🍽️"];
    const displayed = new Set();
    const createCard = cat => {
        const parts = cat.split(' ');
        const emoji = parts.pop(), text = parts.join(' ');
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `<div class="category-card-icon">${emoji}</div><h2 class="category-card-title">${text}</h2>`;
        card.onclick = () => showCategoryItems(cat);
        container.appendChild(card);
        displayed.add(cat);
    };
    categoryOrder.forEach(cat => { if (allMenuItems[cat]) createCard(cat); });
    Object.keys(allMenuItems).forEach(cat => { if (!displayed.has(cat)) createCard(cat); });
    
    document.getElementById('categories-container').classList.remove('hidden');
    document.getElementById('menu-container').classList.add('hidden');
    document.getElementById('search-input').value = '';
  }

  function showCategoryItems(categoryName, searchResults = null) {
    const container = document.getElementById('menu-container');
    const itemsToShow = searchResults || allMenuItems[categoryName];
    
    container.innerHTML = `<div class="menu-header"><h2 class="category-title">${categoryName}</h2><button class="back-btn" onclick="displayCategories()">الرجوع للأقسام</button></div>`;
    const grid = document.createElement('div');
    grid.className = 'menu-grid';
    
    if(!itemsToShow || itemsToShow.length === 0) {
        grid.innerHTML = '<p style="text-align:center;">لا توجد أصناف في هذا القسم.</p>';
    } else {
        itemsToShow.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <div class="item-details">
                    <h3 class="item-name">${item.name}</h3>
                    <p class="item-price">${parseFloat(item.price).toFixed(2)} جنيه</p>
                </div>
                <div class="item-actions">
                    <button class="add-to-cart-btn" onclick="addToCart(event, '${item.name}', ${item.price})">أضف للسلة</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }
    container.appendChild(grid);
    document.getElementById('categories-container').classList.add('hidden');
    container.classList.remove('hidden');
  }

  function filterMenu() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    if (!searchTerm) { displayCategories(); return; }
    
    let results = [];
    for (const category in allMenuItems) {
        allMenuItems[category].forEach(item => {
            if (item.name.toLowerCase().includes(searchTerm)) {
                results.push(item);
            }
        });
    }
    showCategoryItems(`نتائج البحث عن: "${searchTerm}"`, results);
  }

  function addToCart(event, itemName, itemPrice) {
    event.stopPropagation();
    if (cart[itemName]) {
      cart[itemName].quantity++;
    } else {
      cart[itemName] = { name: itemName, price: itemPrice, quantity: 1 };
    }
    updateCartDisplay();
  }

  function removeFromCart(itemName) {
    delete cart[itemName];
    updateCartDisplay();
  }

  function updateCartDisplay() {
    const list = document.getElementById('cart-items-list');
    const countEl = document.getElementById('cart-item-count');
    const totalEl = document.getElementById('total-price');
    list.innerHTML = '';
    let totalItems = 0, totalPrice = 0;
    
    Object.values(cart).forEach(item => {
      totalItems += item.quantity;
      totalPrice += item.price * item.quantity;
      const li = document.createElement('li');
      li.innerHTML = `<span>${item.name} (x${item.quantity})</span><span>${(item.price * item.quantity).toFixed(2)} جنيه <button class="remove-item-btn" onclick="removeFromCart('${item.name}')">🗑️</button></span>`;
      list.appendChild(li);
    });
    
    countEl.textContent = totalItems;
    countEl.style.display = totalItems > 0 ? 'flex' : 'none';
    totalEl.textContent = `الإجمالي: ${totalPrice.toFixed(2)} جنيه`;
    document.querySelectorAll('#order-btn, #paymob-order-btn').forEach(b => b.disabled = totalItems === 0);
  }

  async function placeWalletOrder() {
    if (Object.keys(cart).length === 0) return;
    document.querySelectorAll('.modal-btn').forEach(b => b.disabled = true);
    try {
      const result = await apiCall('process-wallet-order', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: Object.values(cart), notes: document.getElementById('order-notes').value })
      });
      alert(`تم استلام طلبك بنجاح! رقم طلبك: ${result.orderId}`);
      cart = {};
      updateCartDisplay();
      toggleModal('cart-modal-overlay');
      initializeApp();
    } catch (error) {
      alert(`فشل الطلب: ${error.message}`);
    } finally {
      document.querySelectorAll('.modal-btn').forEach(b => b.disabled = false);
    }
  }

  async function initiateCardPayment() {
    if (Object.keys(cart).length === 0) return;
    document.querySelectorAll('.modal-btn').forEach(b => b.disabled = true);
    try {
      const result = await apiCall('start-paymob-payment', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: Object.values(cart) })
      });
      window.top.location.href = result.redirectUrl;
    } catch (error) {
      alert(`فشل الاتصال ببوابة الدفع: ${error.message}`);
      document.querySelectorAll('.modal-btn').forEach(b => b.disabled = false);
    }
  }

  async function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    const isOpen = modal.classList.toggle('show');
    
    if (isOpen && modalId === 'history-modal-overlay') {
      const list = document.getElementById('history-items-list');
      list.innerHTML = '<li>جاري تحميل السجل...</li>';
      try {
        const history = await apiCall('orders');
        list.innerHTML = '';
        if (history.length === 0) { list.innerHTML = '<li>لم تقم بأي طلبات بعد.</li>'; return; }
        
        history.forEach(order => {
          const li = document.createElement('li');
          const statusClass = order.status === 'جاهز للاستلام' ? 'status-ready' : order.status === 'مرفوض' ? 'status-rejected' : 'status-pending';
          const date = new Date(order.created_at).toLocaleString('ar-EG', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
          const itemsText = order.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
          const reorderButtonHtml = order.status !== 'مرفوض' ? `<button class="reorder-btn" onclick='reorder(${JSON.stringify(order.items)})'>اطلبها مجددًا</button>` : '';

          li.innerHTML = `
            <div style="width: 100%">
              <div style="display:flex; justify-content:space-between; font-weight:700">
                <span>${order.display_id}</span>
                <span class="${statusClass}">${order.status}</span>
              </div>
              <div><small>${date} - الإجمالي: ${parseFloat(order.totalPrice).toFixed(2)} جنيه</small></div>
              <p style="margin: 5px 0;">${itemsText}</p>
              ${order.status === 'مرفوض' && order.notes ? `<p style="color: var(--danger); margin: 5px 0;"><b>السبب:</b> ${order.notes.replace('سبب الرفض: ', '')}</p>` : ''}
              ${reorderButtonHtml}
            </div>`;
          list.appendChild(li);
        });
      } catch(error) { list.innerHTML = `<li>فشل تحميل السجل: ${error.message}</li>`; }
    }
  }

  function reorder(items) {
    items.forEach(item => {
        if (cart[item.name]) {
            cart[item.name].quantity += item.quantity;
        } else {
            cart[item.name] = item;
        }
    });
    updateCartDisplay();
    toggleModal('history-modal-overlay');
    toggleModal('cart-modal-overlay');
    alert("تمت إضافة أصناف الطلب القديم إلى سلتك الحالية!");
  }

  async function trackMyOrder() {
    const orderId = document.getElementById('order-id-input').value.trim();
    const resultEl = document.getElementById('tracking-result');
    if (!orderId) { resultEl.textContent = "الرجاء إدخال رقم الطلب."; return; }
    resultEl.textContent = 'جاري البحث...';
    try {
        const response = await apiCall(`order-status/${orderId}`);
        resultEl.textContent = `حالة الطلب: ${response.status}`;
        let color = 'var(--warning)';
        if (response.status === "جاهز للاستلام") color = "var(--success)";
        if (response.status === "مرفوض") color = "var(--danger)";
        resultEl.style.color = color;
    } catch (error) {
        resultEl.textContent = "رقم الطلب غير صحيح أو غير موجود.";
        resultEl.style.color = "var(--danger)";
    }
  }

  function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    document.getElementById('theme-toggle-btn').innerHTML = isLight ? '☀️' : '🌙';
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
  }
</script>
</body>
</html>

